<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Easy Buy MILK-ADMIN UI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 500px;
        margin: 40px auto;
        background: #f0f2f5;
        padding: 20px;
        border-radius: 10px;
        box-shadow: 0 0 15px rgba(0, 0, 0, 0.1);
      }

      h2 {
        text-align: center;
      }

      label,
      input {
        display: block;
        width: 100%;
        margin-top: 10px;
      }

      input {
        padding: 10px;
        margin-bottom: 15px;
        border-radius: 5px;
        border: 1px solid #ccc;
      }

      button {
        padding: 10px;
        width: 100%;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        cursor: pointer;
      }

      button:hover {
        background: #0056b3;
      }

      .message {
        margin: 10px 0;
        min-height: 20px;
        font-weight: bold;
      }

      .message.error {
        color: #c00;
      }
      .message.success {
        color: #0a0;
      }

      .hidden {
        display: none;
      }

      pre {
        background: #eee;
        padding: 15px;
        border-radius: 6px;
        white-space: pre-wrap;
      }
      .link-row {
        display: flex;
        justify-content: space-between;
        margin-top: 10px;
      }

      .link-row a {
        color: #007bff;
        text-decoration: none;
        font-size: 0.95rem;
      }

      .link-row a:hover {
        text-decoration: underline;
      }

      /* User section styling */
      #user-section {
        background: transparent; /* clear background */
        padding: 10px;
        margin-top: 10px;
      }

      /* Smaller buttons */
      #user-section button {
        padding: 5px 8px;
        font-size: 13px;
        border-radius: 4px;
      }

      /* Smaller search bar */
      #searchInput {
        font-size: 13px;
        padding: 5px;
      }

      /* Table styling */
      table {
        width: 100%;
        border-collapse: collapse;
        margin: 20px auto;
        text-align: center;
      }

      th,
      td {
        padding: 10px;
        border: 3px solid #ccc;
        text-align: center; /* Center-align content */
        vertical-align: middle;
      }

      /* Logout button special styling */
      #logout-btn {
        background: transparent;
        color: #dc3545;
        margin-bottom: 1px;
        border: 1px solid #000bff;
        font-weight: bold;
      }
      #logout-btn:hover {
        background: rgba(100, 103, 69, 0.1);
      }

      /* Export Button */
      #export-btn {
        background: transparent;
        color: #8c3545;
        margin-bottom: 1px;
        border: 1px solid #8c3545;
        font-weight: bold;
      }
      #export-btn:hover {
        background: rgba(140, 53, 69, 0.1);
      }

      /* Menu Button */
      #menu-btn {
        background: transparent;
        color: #000bff;
        margin-bottom: 1px;
        border: 1px solid #000bff;
        font-weight: bold;
      }
      #menu-btn:hover {
        background: rgba(100, 103, 69, 0.1);
      }
      section {
        display: none;
      }

      .delete-btn {
        cursor: pointer;
        background: transparent;
        border: none;
        color: red; /* üî¥ Red color */
        font-size: 18px;
        transition: all 0.2s;
      }
      .delete-btn:hover {
        color: #fa0000; /* brighter red on hover */
        transform: scale(1.2);
      }

      .edit-btn {
        cursor: pointer;
        background: transparent;
        border: none;
        color: Yellow; /* üî¥ Red color */
        font-size: 18px;
        transition: all 0.2s;
      }
      .edit-btn:hover {
        color: #fa0000; /* brighter red on hover */
        transform: scale(1.2);
      }

      /* General button style */
      .order-btn {
        padding: 5px 10px;
        margin: 2px;
        border: none;
        border-radius: 4px;
        color: white;
        cursor: pointer;
        font-size: 13px;
        transition: transform 0.2s;
      }

      .order-btn:hover {
        transform: scale(1.1);
      }

      /* Specific action colors */
      .btn-confirm {
        background-color: #28a745;
      } /* Green */
      .btn-cancel {
        background-color: #dc3545;
      } /* Red */
      .btn-out {
        background-color: #ffc107;
        color: #000;
      } /* Yellow */
      .btn-delivered {
        background-color: #007bff;
      } /* Blue */
    </style>
  </head>
  <body>
    <div id="orderTimeline"></div>

    <h2>Easy Buy MILK-ADMIN</h2>

    <div class="message" id="message"></div>
    <div id="auth-forms">
      <!-- Login Form -->
      <div id="login-form">
        <input
          type="email"
          id="email"
          placeholder="EmailId/MobileNumber/UserName"
        />
        <input type="password" id="password" placeholder="Password" />
        <button onclick="login()">üîë Login</button>

        <div class="link-row">
          <a href="#" onclick="showForm('signup-form')">Create account</a>
          <a href="#" onclick="showForm('forgot-form')">Forgot Password</a>
        </div>
      </div>

      <!-- Signup Form -->
      <div id="signup-form" class="hidden">
        <input type="email" id="signup-email" placeholder="EmailId" />
        <input type="password" id="signup-password" placeholder="Password" />
        <button onclick="signup()">üìù Signup</button>
        <p><a href="#" onclick="showForm('login-form')">‚Üê Back to Login</a></p>
      </div>

      <!-- Forgot Password Form -->
      <div id="forgot-form" class="hidden">
        <input type="email" id="forgot-email" placeholder="EmailId" />
        <button onclick="forgotPassword()">üì© forgot password</button>
        <p><a href="#" onclick="showForm('reset-form')">‚Üê Back to Login</a></p>
      </div>

      <!-- Reset Password Form -->
      <div id="reset-form" class="hidden">
        <input type="email" id="reset-email" placeholder="EmailId" readonly />
        <input type="text" id="reset-token" placeholder="Token" />
        <input type="password" id="reset-password" placeholder="New Password" />
        <button onclick="resetPassword()">üîÅüîí Reset password</button>
      </div>
    </div>

    <div id="user-section" class="hidden">
      <!-- Menu -->
      <nav
        style="display: flex; align-items: center; gap: 8px; margin-bottom: 8px"
      >
        <button id="menu-btn" onclick="showSection('orders')">Orders</button>
        <!-- <button id="menu-btn" onclick="showSection('history')" >History</button> -->
        <button id="menu-btn" onclick="showSection('users')">Users</button>
        <button id="menu-btn" onclick="showSection('profile')">Profile</button>
        <button id="logout-btn" onclick="logout()">Logout</button>
      </nav>

      <!-- <div id="message" style="color: red; margin-bottom: 8px;"></div> -->

      <!-- USERS -->
      <div id="users" class="section">
        <div
          style="
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
          "
        >
          <button id="export-btn" onclick="exportToExcel('users')">
            üìä Excel
          </button>
          <button id="export-btn" onclick="exportToCSV('users')">üìÑ CSV</button>
          <button id="export-btn" onclick="exportToPDF('users')">üìï PDF</button>
          <input
            type="text"
            id="searchInputUsers"
            placeholder="Filter users..."
            oninput="filterTable('users')"
            style="flex-grow: 1; min-width: 150px; padding: 5px"
          />
        </div>
        <table
          id="userTable"
          border="1"
          style="width: 100%; margin-top: 5px; border-collapse: collapse"
        >
          <thead>
            <tr id="tableHeaderUsers"></tr>
          </thead>
          <tbody id="tableBodyUsers"></tbody>
        </table>
      </div>

      <!-- Orders -->
      <div id="orders" class="section">
        <div
          style="
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
          "
        >
          <button id="export-btn" onclick="exportToExcel('orders')">
            üìä Excel
          </button>
          <button id="export-btn" onclick="exportToCSV('orders')">
            üìÑ CSV
          </button>
          <button id="export-btn" onclick="exportToPDF('orders')">
            üìï PDF
          </button>
          <input
            type="text"
            id="searchInputHistory"
            placeholder="Filter Orders..."
            oninput="filterTable('orders')"
            style="flex-grow: 1; min-width: 150px; padding: 5px"
          />
        </div>
        <table
          id="OrdersTable"
          border="1"
          style="width: 100%; margin-top: 5px; border-collapse: collapse"
        >
          <thead>
            <tr id="tableHeaderOrders"></tr>
          </thead>
          <tbody id="tableBodyOrders"></tbody>
        </table>
      </div>

      <!-- Order History -->
      <div id="history" class="section">
        <div
          style="
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
          "
        >
          <button id="export-btn" onclick="exportToExcel('history')">
            üìä Excel
          </button>
          <button id="export-btn" onclick="exportToCSV('history')">
            üìÑ CSV
          </button>
          <button id="export-btn" onclick="exportToPDF('history')">
            üìï PDF
          </button>
          <input
            type="text"
            id="searchInputHistory"
            placeholder="Filter History..."
            oninput="filterTable('history')"
            style="flex-grow: 1; min-width: 150px; padding: 5px"
          />
        </div>
        <table
          id="historyTable"
          border="1"
          style="width: 100%; margin-top: 5px; border-collapse: collapse"
        >
          <thead>
            <tr id="tableHeaderHistory"></tr>
          </thead>
          <tbody id="tableBodyHistory"></tbody>
        </table>
      </div>

      <!-- Order Form -->
      <div
        id="order-form"
        class="hidden"
        style="max-width: 400px; margin: auto"
      >
        <!-- Quantity + Amount in same row -->
        <div style="display: flex; gap: 10px; align-items: center">
          <div style="flex: 1">
            <label for="quantity">Quantity</label>
            <select
              id="quantity"
              required
              onchange="updateAmount()"
              style="width: 100%"
            >
              <option value="">-- Select Quantity --</option>
              <option value="100mL">100 mL</option>
              <option value="250mL">250 mL</option>
              <option value="500mL">500 mL</option>
              <option value="1L">1 L</option>
              <option value="2L">2 L</option>
              <option value="3L">3 L</option>
              <option value="5L">5 L</option>
            </select>
          </div>

          <div style="flex: 1">
            <label for="amount">Amount (‚Çπ)</label>
            <input type="text" id="amount" readonly style="width: 70%" />
          </div>
        </div>

        <label for="paymentType">Payment Type</label>
        <select id="paymentType" required style="width: 100%">
          <option value="">-- Select Payment Type --</option>
          <option value="CASH">CASH</option>
          <option value="CARD">CARD</option>
          <option value="UPI">UPI</option>
          <option value="FT">FT</option>
          <option value="BUSINESS CREDIT">BUSINESS CREDIT</option>
        </select>

        <label for="mobileNumber">Mobile Number</label>
        <input
          type="tel"
          id="mobilenumber"
          placeholder="Enter Mobile Number"
          pattern="[0-9]{10}"
          maxlength="10"
          required
          style="width: 100%"
        />

        <label for="address">Delivery Address</label>
        <textarea
          id="address"
          placeholder="Enter Delivery Address"
          rows="3"
          maxlength="200"
          required
          style="width: 100%; resize: vertical"
        ></textarea>

        <button onclick="orderApi()">üõí Place Your Order</button>
      </div>

      <!-- Profile Section -->
      <div id="profile" class="section" style="max-width: 400px; margin: auto">
        <h3>üë§ Update Profile</h3>
        <label>EmailId</label>
        <input type="email" id="profile-email" readonly />
        <label>First Name</label>
        <input type="text" id="profile-firstName" maxlength="50" />
        <label>Last Name</label>
        <input type="text" id="profile-lastName" maxlength="50" />
        <label>Mobile Number</label>
        <input
          type="tel"
          id="profile-mobile"
          maxlength="10"
          pattern="[0-9]{10}"
        />
        <label>Address</label>
        <textarea
          id="profile-address"
          rows="3"
          maxlength="200"
          style="width: 100%; resize: vertical"
        ></textarea>
        <div
          style="
            display: flex;
            justify-content: space-between;
            gap: 10px;
            margin-top: 10px;
          "
        >
          <button onclick="updateProfile()">üíæ Save</button>
          <button onclick="showSection('orders')">‚ùå Cancel</button>
        </div>
      </div>
    </div>

    <!-- Modal Structure -->
    <div
      id="timelineModal"
      style="
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 1000;
        justify-content: center;
        align-items: center;
      "
    >
      <div
        style="
          background: #fff;
          padding: 20px;
          border-radius: 8px;
          width: 90%;
          max-width: 500px;
          max-height: 80%;
          overflow-y: auto;
          position: relative;
        "
      >
        <span
          style="
            position: absolute;
            top: 10px;
            right: 15px;
            cursor: pointer;
            font-size: 24px;
          "
          onclick="closeTimelinePopup()"
          >√ó</span
        >
        <h2 style="text-align: center; margin-bottom: 20px">Order Timeline</h2>
        <div id="popupTimeline"></div>
      </div>
    </div>

    <script>
      const API_BASE = "http://localhost:3000/api";
      const token = localStorage.getItem("token") || "";
      const userId = localStorage.getItem("userId") || "";
      const expiry = localStorage.getItem("tokenExpiry") || "";
      let resetEmail = "";
      const data = { users: [], history: [], orders: [] };
      const excludeFields = [
        "passwordHash",
        "resetToken",
        "userId",
        "recordId",
      ];

      function showMessage(msg, error = false) {
        const el = document.getElementById("message");
        el.textContent = msg;
        el.className = "message " + (error ? "error" : "success");
      }

      function clearMessage() {
        showMessage("");
      }

      function showForm(formId) {
        // Hide all forms
        document
          .querySelectorAll("#auth-forms > div, #order-form")
          .forEach((div) => div.classList.add("hidden"));

        // Hide all sections
        document.querySelectorAll(".section").forEach((sec) => {
          sec.style.display = "none";
          // clear section data (like tables)
          if (sec.querySelector("tbody"))
            sec.querySelector("tbody").innerHTML = "";
        });

        // Clear form inputs
        const formEl = document.getElementById(formId);
        if (formEl) {
          formEl
            .querySelectorAll("input, select")
            .forEach((input) => (input.value = ""));
          formEl.classList.remove("hidden");
        }

        clearMessage();
      }

      async function signup() {
        const email = document.getElementById("signup-email").value.trim();
        const password = document
          .getElementById("signup-password")
          .value.trim();
        const role = "ADMIN";

        if (!email || !password) {
          showMessage("Email and password required.", true);
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/auth/signup`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ emailId: email, password, role }),
          });
          const result = await res.json();
          if (!res.ok) throw new Error(result.message || "Signup failed.");
          alert("‚úÖ Signup successful! Please login.");
          showForm("login-form");
        } catch (err) {
          showMessage(`‚ùå Signup error: ${err.message}`, true);
        }
      }

      async function login() {
        const email = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        if (!email || !password) {
          return showMessage("All fields are required.", true);
        }

        try {
          const res = await fetch(`${API_BASE}/auth/login`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ emailId: email, password }),
          });

          const result = await res.json();
          if (!res.ok) throw new Error(result.message || "Login failed.");
          if (result.role !== "ADMIN") {
            alert("‚ùå Login with Admin User");
            document.getElementById("auth-forms").classList.remove("hidden");
            document.getElementById("user-section").classList.add("hidden");
            document.getElementById("password").value = "";
            localStorage.clear();
            showForm("login-form");
          } else {
            localStorage.setItem("token", result.token);
            localStorage.setItem("userId", result.userId);
            localStorage.setItem("role", result.role);
            localStorage.setItem("email", email);
            showLoggedInView();
          }
        } catch (err) {
          showMessage(`‚ùå Login error: ${err.message}`, true);
        }
      }

      async function logout() {
        const userId = localStorage.getItem("userId");
        try {
          if (userId) {
            await fetch(
              `${API_BASE}/auth/logout/${encodeURIComponent(userId)}`,
              {
                method: "PUT",
                headers: {
                  Authorization: `Bearer ${localStorage.getItem("token")}`,
                },
              }
            );
          }
        } catch (e) {
          console.warn("Logout request failed.");
        } finally {
          localStorage.clear();
          document.getElementById("auth-forms").classList.remove("hidden");
          document.getElementById("user-section").classList.add("hidden");
          document.getElementById("password").value = "";
          showMessage("You have logged out.");
          showForm("login-form");
        }
      }

      async function forgotPassword() {
        const emailId = document.getElementById("forgot-email").value.trim();
        if (!emailId) {
          showMessage("‚ùå Please enter your email", true);
          return;
        }

        try {
          showMessage("Sending reset request...");
          const res = await fetch(`${API_BASE}/auth/forgot`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ emailId }),
          });

          const result = await res.json();
          if (!res.ok) throw new Error(result.message || "API error");
          showMessage("‚úÖ Reset token sent to your email");

          // ‚úÖ Copy email into reset form
          document.getElementById("reset-email").value = emailId;

          // ‚úÖ Switch to reset form
          showForm("reset-form");
        } catch (err) {
          console.error("ForgotPassword Error:", err);
          showMessage(`‚ùå ${err.message}`, true);
        }
      }

      async function resetPassword() {
        const tokenVal = document.getElementById("reset-token").value.trim();
        const password = document.getElementById("reset-password").value.trim();
        const resetEmail = document.getElementById("reset-email").value.trim();

        if (!resetEmail || !tokenVal || !password) {
          return showMessage("All fields are required.", true);
        }

        try {
          const res = await fetch(`${API_BASE}/auth/reset`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              emailId: resetEmail,
              newPassword: password,
              token: tokenVal,
            }),
          });

          const result = await res.json();
          if (!res.ok) throw new Error(result.message || "Reset failed");
          alert("‚úÖ Password reset successful");
          document.getElementById("reset-email").value = "";
          document.getElementById("reset-token").value = "";
          document.getElementById("reset-password").value = "";
          localStorage.clear();
          showForm("login-form");
        } catch (err) {
          showMessage(`‚ùå Reset error: ${err.message}`, true);
        }
      }

      async function fetchData(sectionId, endpoint) {
        try {
          showMessage(`Loading ${capitalize(sectionId)}...`);
          const res = await fetch(`${API_BASE}${endpoint}`, {
            headers: {
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
          });

          if (res.status === 401) {
            localStorage.removeItem("token");
            alert("Token Expired");
            showForm("login-form");
            return;
          }

          const result = await res.json();

          if (res.status === 401) {
            localStorage.clear();
            document.getElementById("auth-forms").classList.remove("hidden");
            document.getElementById("user-section").classList.add("hidden");
            document.getElementById("password").value = "";
            alert("Token Expired");
            showForm("login-form");
            return;
          } else if (res.status === 404)
            showMessage(`‚ùå ${result.message}`, true);
          else if (!res.ok) throw new Error(result.message || "API error");
          const respData = result.data;
          data[sectionId] = Array.isArray(respData) ? respData : [];
          renderTable(sectionId);
          clearMessage();
        } catch (err) {
          console.error("FetchData Error:", err);
          showMessage(`‚ùå Error loading ${sectionId}: ${err.message}`, true);
        }
      }

      // Call loadProfile after login
      function showLoggedInView() {
        document.getElementById("auth-forms").classList.add("hidden");
        document.getElementById("user-section").classList.remove("hidden");
        showMessage("‚úÖ Logged in successfully");
        showSection("orders");
      }

      function capitalize(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
      }

      // ------------------- RENDER TABLE -------------------
      function renderTable(sectionId) {
        const sectionData = data[sectionId];
        const header = document.getElementById(
          `tableHeader${capitalize(sectionId)}`
        );
        const body = document.getElementById(
          `tableBody${capitalize(sectionId)}`
        );

        header.innerHTML = "";
        body.innerHTML = "";

        if (!sectionData || sectionData.length === 0) {
          showMessage(`No data found for ${capitalize(sectionId)}`, true);
          return;
        }

        const keys = Object.keys(sectionData[0]).filter(
          (k) => !excludeFields.includes(k)
        );

        // Add Action column header only for sections with actions
        const hasActions = sectionId === "users" || sectionId === "orders";
        if (hasActions) {
          const thAction = document.createElement("th");
          thAction.textContent = "Action";
          header.appendChild(thAction);
        }

        // Add other headers
        keys.forEach((key) => {
          const th = document.createElement("th");
          th.textContent = key;
          header.appendChild(th);
        });

        // Add table rows
        sectionData.forEach((row) => {
          const tr = document.createElement("tr");

          // ------------------- USERS -------------------
          if (sectionId === "users") {
            const tdAction = document.createElement("td");

            // Toggle Status Button
            const toggleBtn = document.createElement("button");
            toggleBtn.innerHTML = row.status ? "‚úÖ Active" : "‚ùå Inactive";
            toggleBtn.className = row.status ? "active-btn" : "inactive-btn";
            toggleBtn.title = "Toggle User Status";
            toggleBtn.onclick = () => {
              const status = !row.status;
              const confirmMsg = `Do you want to change user status?`;
              if (confirm(confirmMsg)) {
                updateUserStatus(row.userId, status);
              }
            };
            tdAction.appendChild(toggleBtn);

            // Delete Button
            const delBtn = document.createElement("button");
            delBtn.innerHTML = "üóëÔ∏è";
            delBtn.className = "delete-btn";
            delBtn.title = "Delete User";
            delBtn.onclick = () => deleteUser(row.userId);
            tdAction.appendChild(delBtn);

            tr.appendChild(tdAction);

            keys.forEach((key) => {
              const td = document.createElement("td");
              td.innerHTML = formatCell(row, key);
              tr.appendChild(td);
            });
          }

          // ------------------- ORDERS -------------------
          else if (sectionId === "orders") {
            const tdAction = document.createElement("td");
            const status = (row.status || "NEW").toUpperCase();
            const orderId = row.orderId || row._id;
            const mode = row.paymentType || row._paymentType || "UNKNOWN";

            // Start with existing action buttons depending on status
            if (status === "NEW") {
              tdAction.innerHTML = `
					<button class="order-btn btn-confirm" onclick="updateOrderStatus('${orderId}', 'CONFIRMED', '${mode}')">Confirm</button>
					<button class="order-btn btn-cancel" onclick="updateOrderStatus('${orderId}', 'CANCELED', '${mode}')">Cancel</button>
				`;
            } else if (status === "CONFIRMED") {
              tdAction.innerHTML = `
					<button class="order-btn btn-out" onclick="updateOrderStatus('${orderId}', 'OUT FOR DELIVERY', '${mode}')">Out for Delivery</button>
					<button class="order-btn btn-cancel" onclick="updateOrderStatus('${orderId}', 'CANCELED', '${mode}')">Cancel</button>
				`;
            } else if (status === "OUT FOR DELIVERY") {
              tdAction.innerHTML = `
					<button class="order-btn btn-delivered" onclick="updateOrderStatus('${orderId}', 'DELIVERED', '${mode}')">Deliver</button>
					<button class="order-btn btn-cancel" onclick="updateOrderStatus('${orderId}', 'CANCELED', '${mode}')">Cancel</button>
				`;
            } else if (status === "DELIVERED" || status === "CANCELED") {
              tdAction.innerHTML = formatCell(row, "status"); // keep colored status display
            }

            // Add eye button to view journey if status changed from NEW
            if (status !== "NEW") {
              tdAction.innerHTML += `
					<button class="order-btn btn-journey" title="View Journey" onclick="getOrderSummary('${orderId}')">üëÅÔ∏è</button>
				`;
            }

            tr.appendChild(tdAction);

            // Append all other columns
            keys.forEach((key) => {
              const td = document.createElement("td");
              td.innerHTML = formatCell(row, key);
              tr.appendChild(td);
            });
          }

          // ------------------- OTHER SECTIONS -------------------
          else {
            if (hasActions) {
              const tdEmpty = document.createElement("td");
              tdEmpty.textContent = "";
              tr.appendChild(tdEmpty);
            }

            keys.forEach((key) => {
              const td = document.createElement("td");
              td.innerHTML = formatCell(row, key);
              tr.appendChild(td);
            });
          }

          body.appendChild(tr);
        });
      }

      // ------------------- FORMAT CELL -------------------
      function formatCell(row, key) {
        const value = row[key];

        // STATUS field coloring
        if (key === "status") {
          let display = "";
          let color = "black";

          if (typeof value === "boolean") {
            display = value ? "ACTIVE" : "IN-ACTIVE";
            color = value ? "green" : "red";
          } else if (typeof value === "string") {
            const status = value.toUpperCase();
            display = status;
            switch (status) {
              case "DELIVERED":
                color = "green";
                break;
              case "CANCELED":
                color = "red";
                break;
              case "CONFIRMED":
                color = "blue";
                break;
              case "OUT FOR DELIVERY":
                color = "orange";
                break;
              case "NEW":
                color = "purple";
                break;
              default:
                color = "black";
            }
          } else {
            display = value;
          }

          return `<span style="color: ${color}; font-weight: bold;">${display}</span>`;
        }

        // Other boolean fields
        const booleanKeys = ["firstUse", "logIn", "status"];
        if (booleanKeys.includes(key)) {
          return value
            ? `<span style="color: green; font-weight: bold;">Yes</span>`
            : `<span style="color: red; font-weight: bold;">No</span>`;
        }

        return value ?? "";
      }

      // ------------------- FILTER TABLE WITH HIGHLIGHT -------------------
      function filterTable(sectionId) {
        const input = document
          .getElementById(`searchInput${capitalize(sectionId)}`)
          .value.toLowerCase();
        const rows = document.querySelectorAll(
          `#tableBody${capitalize(sectionId)} tr`
        );

        rows.forEach((row) => {
          let rowMatches = false;

          row.querySelectorAll("td").forEach((td) => {
            const text = td.textContent.toLowerCase();
            if (input && text.includes(input)) {
              rowMatches = true;

              // Highlight matching text
              const regex = new RegExp(`(${input})`, "gi");
              td.innerHTML = td.textContent.replace(regex, "<mark>$1</mark>");
            } else {
              // Remove previous highlights if not matching
              td.innerHTML = td.textContent;
            }
          });

          row.style.display = rowMatches || !input ? "" : "none";
        });
      }

      function showSection(sectionId) {
        // Hide all sections
        document.querySelectorAll(".section").forEach((sec) => {
          sec.style.display = "none";
          if (sec.querySelector("tbody"))
            sec.querySelector("tbody").innerHTML = "";
        });

        // Hide all forms
        document
          .querySelectorAll("#auth-forms > div, #order-form")
          .forEach((div) => div.classList.add("hidden"));
        document.getElementById("reset-form").classList.add("hidden"); // ensure reset form also hidden

        // Show the selected section
        const sectionEl = document.getElementById(sectionId);
        if (sectionEl) sectionEl.style.display = "block";

        clearMessage();

        // Load data only when needed
        if (sectionId === "users") {
          document.getElementById("users").style.display = "block";
          fetchData("users", `/auth/getAllUsers`);
        } else if (sectionId === "history") {
          document.getElementById("history").style.display = "block";
          fetchData("history", `/history/all`);
        } else if (sectionId === "orders") {
          document.getElementById("orders").style.display = "block";
          fetchData("orders", `/order/all`);
        } else if (sectionId === "profile") {
          document.getElementById("profile").style.display = "block";
          loadProfile();
        }
      }

      function exportToExcel(sectionId) {
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.json_to_sheet(data[sectionId]);
        XLSX.utils.book_append_sheet(wb, ws, capitalize(sectionId));
        XLSX.writeFile(wb, `${sectionId}.xlsx`);
      }

      function exportToCSV(sectionId) {
        const ws = XLSX.utils.json_to_sheet(data[sectionId]);
        const csv = XLSX.utils.sheet_to_csv(ws);
        const blob = new Blob([csv], { type: "text/csv" });
        const a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = `${sectionId}.csv`;
        a.click();
      }

      function exportToPDF(sectionId) {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        const tableData = data[sectionId].map((obj) => Object.values(obj));
        const columns = Object.keys(data[sectionId][0]).filter(
          (k) => !excludeFields.includes(k)
        );
        doc.autoTable({ head: [columns], body: tableData });
        doc.save(`${sectionId}.pdf`);
      }

      function updateAmount() {
        const priceMap = {
          "100mL": 5,
          "250mL": 15,
          "500mL": 25,
          "1L": 45,
          "2L": 90,
          "3L": 135,
          "5L": 225,
        };

        const qty = document.getElementById("quantity").value;
        document.getElementById("amount").value = qty ? priceMap[qty] : "";
      }

      async function orderApi() {
        const quantity = document.getElementById("quantity").value.trim();
        const amount = document.getElementById("amount").value.trim();
        const paymentType = document.getElementById("paymentType").value.trim();
        const mobileNumber = document
          .getElementById("mobilenumber")
          .value.trim();
        const address = document.getElementById("address").value.trim();

        if (
          !userId ||
          !quantity ||
          !amount ||
          !paymentType ||
          !mobileNumber ||
          !address
        ) {
          return showMessage("All fields are required.", true);
        }

        try {
          const res = await fetch(`${API_BASE}/order/new`, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({
              userId,
              quantity,
              price: amount,
              paymentType,
              mobileNumber,
              address,
            }),
          });

          const result = await res.json();
          if (!res.ok) throw new Error(result.message || "Order failed");
          alert("‚úÖ Order successful");
        } catch (err) {
          showMessage(`‚ùå Order error: ${err.message}`, true);
        }
      }

      // Load current user's profile into fields
      async function loadProfile() {
        const userId = localStorage.getItem("userId");
        if (!userId) return showForm("login-form");

        try {
          const res = await fetch(
            `${API_BASE}/auth/getUserById/${encodeURIComponent(userId)}`,
            {
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );
          const result = await res.json();
          if (!res.ok)
            throw new Error(result.message || "Failed to fetch profile");

          const user = result.data;
          document.getElementById("profile-email").value = user.emailId || "";
          document.getElementById("profile-firstName").value =
            user.firstName || "";
          document.getElementById("profile-lastName").value =
            user.lastName || "";
          document.getElementById("profile-mobile").value =
            user.mobileNumber || "";
          document.getElementById("profile-address").value = user.address || "";
        } catch (err) {
          showMessage(`‚ùå Error loading profile: ${err.message}`, true);
        }
      }

      // Update current user's profile
      async function updateProfile() {
        const userId = localStorage.getItem("userId");
        const userEmailId = localStorage.getItem("email");
        const emailId = document.getElementById("profile-email").value.trim();
        const firstName = document
          .getElementById("profile-firstName")
          .value.trim();
        const lastName = document
          .getElementById("profile-lastName")
          .value.trim();
        const mobileNumber = document
          .getElementById("profile-mobile")
          .value.trim();
        const address = document.getElementById("profile-address").value.trim();

        if (!userId || !emailId)
          return showMessage("‚ö†Ô∏è Missing user info.", true);

        try {
          const res = await fetch(`${API_BASE}/auth/updateUser`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({
              userId,
              emailId,
              firstName,
              lastName,
              mobileNumber,
              address,
            }),
          });

          const result = await res.json();
          if (!res.ok) throw new Error(result.message || "Update failed");

          alert("‚úÖ Profile updated successfully!");
          showSection("orders");

          if (emailId !== userEmailId) {
            alert("‚úÖ EmailId updated, Please login again");
            document.getElementById("auth-forms").classList.remove("hidden");
            document.getElementById("user-section").classList.add("hidden");
            document.getElementById("password").value = "";
            document.getElementById("profile-mobile").value = "";
            document.getElementById("profile-address").value = "";
            localStorage.clear();
            showForm("login-form");
          }
        } catch (err) {
          showMessage(`‚ùå Profile update error: ${err.message}`, true);
        }
      }

      async function deleteUser(userId) {
        if (!userId) return showMessage("‚ö†Ô∏è User ID missing.", true);

        if (
          !confirm(
            "‚ö†Ô∏è Are you sure you want to delete this user? This cannot be undone."
          )
        )
          return;

        try {
          const res = await fetch(
            `${API_BASE}/auth/delete/${encodeURIComponent(userId)}`,
            {
              method: "DELETE",
              headers: {
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );
          const result = await res.json();
          if (!res.ok) throw new Error(result.message || "Delete failed");

          showMessage("‚úÖ User deleted successfully.");
          fetchData("users", "/auth/getAllUsers"); // refresh table
        } catch (err) {
          showMessage(`‚ùå Delete failed: ${err.message}`, true);
        }
      }

      async function updateOrderStatus(orderId, newStatus, mode) {
        if (!newStatus) return;

        const upperStatus = newStatus.toUpperCase();
        const upperMode = (mode || "").toUpperCase();

        // Confirm for final statuses
        if (["DELIVERED", "CANCELED"].includes(upperStatus)) {
          if (
            !confirm(
              `‚ö†Ô∏è Are you sure you want to mark this order as ${upperStatus}? This cannot be undone.`
            )
          ) {
            return;
          }
        }

        try {
          const res = await fetch(`${API_BASE}/order/update`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ orderId, status: newStatus }),
          });

          const result = await res.json();
          if (!res.ok)
            throw new Error(result.message || "Failed to update status");

          showMessage(`‚úÖ Order status updated to ${upperStatus}`);
          // Update payment status if delivered and mode is CASH
          if (
            upperStatus === "DELIVERED" &&
            (upperMode === "CASH" || upperMode === "UPI")
          ) {
            updatePaymentStatus(orderId);
          }
          showSection("orders");
        } catch (err) {
          showMessage(`‚ùå Update failed: ${err.message}`, true);
        }
      }

      async function updatePaymentStatus(orderId) {
        if (!orderId) return;

        try {
          const paymentStatus = "PAID";
          const res = await fetch(`${API_BASE}/order/payment`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ orderId, paymentStatus }),
          });

          const result = await res.json();
          if (!res.ok)
            throw new Error(
              result.message || "Failed to update payment status"
            );

          showMessage(`‚úÖ Payment status updated successfully`);
        } catch (err) {
          showMessage(`‚ùå updatePaymentStatus failed: ${err.message}`, true);
        }
      }

      async function updateUserStatus(userId, status) {
        if (!userId) return;
        const memUserId = localStorage.getItem("userId");
        if (userId === memUserId) {
          showMessage(`‚ùå Current User status update is not allowed`, true);
          return;
        }

        try {
          const res = await fetch(`${API_BASE}/auth/updateStatus`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
              Authorization: `Bearer ${localStorage.getItem("token")}`,
            },
            body: JSON.stringify({ userId, status }),
          });

          const result = await res.json();
          if (!res.ok)
            throw new Error(result.message || "Failed to update status");

          showMessage(`‚úÖ User status updated to ${status}`);
          fetchData("users", "/auth/getAllUsers");
        } catch (err) {
          showMessage(`‚ùå Update failed: ${err.message}`, true);
        }
      }

      async function getOrderSummary(orderId) {
        if (!orderId) {
          showMessage("‚ö†Ô∏è Missing orderId", true);
          return;
        }

        try {
          const res = await fetch(
            `${API_BASE}/history/byOrderId/${encodeURIComponent(orderId)}`,
            {
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${localStorage.getItem("token")}`,
              },
            }
          );

          const result = await res.json();
          if (!res.ok)
            throw new Error(result.message || "Failed to get summary");

          const respData = result.data;

          // Ensure we pass the journey array to renderTimeline
          if (respData && Array.isArray(respData)) {
            openTimelinePopup(respData);
          } else {
            openTimelinePopup([]); // empty if no journey
          }
        } catch (err) {
          showMessage(`‚ùå Summary failed: ${err.message}`, true);
        }
      }

      function openTimelinePopup(timelineData) {
        // Sort the data chronologically
        const sortedData = timelineData
          .slice()
          .sort((a, b) => new Date(a.actionOn) - new Date(b.actionOn));

        document.getElementById("timelineModal").style.display = "flex";
        renderTimeline(sortedData, "popupTimeline");
      }

      function closeTimelinePopup() {
        document.getElementById("timelineModal").style.display = "none";
        document.getElementById("popupTimeline").innerHTML = "";
      }

      function renderTimeline(data, containerId) {
        const container = document.getElementById(containerId);
        container.innerHTML = "";

        data.forEach((step, index) => {
          let color;
          switch (step.status) {
            case "DELIVERED":
              color = "green";
              break;
            case "CANCELED":
              color = "red";
              break;
            case "CONFIRMED":
              color = "blue";
              break;
            case "OUT FOR DELIVERY":
              color = "orange";
              break;
            case "NEW":
              color = "purple";
              break;
            default:
              color = "black";
          }

          const isLatest = index === data.length - 1; // Highlight latest
          const item = document.createElement("div");
          item.style.display = "flex";
          item.style.alignItems = "flex-start";
          item.style.marginBottom = "25px";
          item.style.position = "relative";
          item.style.opacity = "0";
          item.style.transform = "translateX(-20px)";
          item.style.transition = "all 0.5s ease";

          item.innerHTML = `
        <div style="flex-shrink:0; position:relative; width:25px; display:flex; justify-content:center;">
          <div style="
            background:${color};
            width:${isLatest ? "18px" : "12px"};
            height:${isLatest ? "18px" : "12px"};
            border-radius:50%;
            margin-top:3px;"></div>
          ${
            index < data.length - 1
              ? `<div style="position:absolute; top:18px; left:50%; transform:translateX(-50%); width:2px; height:calc(100% - 18px); background:#ccc;"></div>`
              : ""
          }
        </div>
        <div style="margin-left:12px; word-wrap: break-word; flex:1;">
          <div style="font-weight:bold; color:${color}; margin-bottom:2px; font-size:1em;">${
            step.status
          }</div>
          <div style="font-size:0.85em; color:#555;">${step.actionOn}</div>
        </div>
      `;

          container.appendChild(item);

          setTimeout(() => {
            item.style.opacity = "1";
            item.style.transform = "translateX(0)";
          }, index * 200);
        });
      }

      // Optional: Close modal when clicking outside content
      document
        .getElementById("timelineModal")
        .addEventListener("click", function (e) {
          if (e.target === this) closeTimelinePopup();
        });
    </script>
  </body>
</html>
